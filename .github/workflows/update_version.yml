# This workflow updates the version of the gh-pages using a tag in the main branch.
name: Update version

on:
  push:
    tags:
      - '*.*.*'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # needed for git committers
      
      - name: ðŸ’ Git committer set-up
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      # check that tag matches `/v[0-9]+(\.[0-9]+)*/`
      - name: ðŸ·ï¸ Check tag
        id: check-tag
        run: echo "tag_version=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: ðŸ Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"
  
      - name: ðŸ“ Set up Python environment
        run: |
          pip install -U pip
          pip install -r requirements.txt 
  
      # store `latest` version number into a variable
      - name: ðŸ”¬ Get latest version number
        id: extract-version
        run: |
          version=$(mike list | grep '\[latest\]' | awk '{print $1}')
          echo "Latest version is $version"
          echo "latest_version=$version" >> "$GITHUB_ENV"

      # check that tag version is different from `latest` version
      - name: ðŸ§® Compare version
        run: |
          if [[ "$tag_version" == "$env.latest_version" ]]; then
            echo "Error: Tag version is the same as latest version"
            exit 1
          else
            echo "Tag version is different from latest version"
          fi

      # update latest version to the tag with mike
      - name: ðŸ“š Build Docs
        run: |
          pip install -U pip
          pip install -r requirements.txt
          mike deploy --push --update-aliases "$tag_version" latest