name: Deploy to latest

on:
  push:
    branches: [main]
  workflow_dispatch:

# Allow this job to clone the repo and create a page deployment
# permissions:
#   contents: read
#   pages: write
#   id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # needed for git committers

      - name: 💁 Git committer set-up
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
      - name: 🐍 Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 📝 Set up Python environment
        run: |
          pip install -U pip
          pip install -r requirements.txt 

      - name: 🔗 Check Links
        run: |
          npm install markdown-link-check@"<3.11.1"
          npx markdown-link-check docs/**/*.md --progress -q

      - name: 📁 Set up repositories
        run: sh scripts/check_out_repos.sh
      
      - name: 📓 Set up notebooks
        run: sh scripts/check_out_notebooks.sh

      - name: 🔬 Get latest version number
        id: extract-version
        run: |
          version=$(mike list | grep '\[latest\]' | awk '{print $1}')
          echo "Latest version is $version"
          echo "latest_version=$version" >> "$GITHUB_ENV"
          
      - name: 📚 Blah
        run: |
          printf '%s\n' "$version" 
          
      - name: 📚 Build Docs
        # removed mkdocs build --strict for now
        run: |
          pip install -U pip
          pip install -r requirements.txt
          mike deploy --push --update-aliases "$latest_version" latest

        # env:
        #   MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        #   GOOGLE_ANALYTICS_KEY: ${{ secrets.GOOGLE_ANALYTICS_KEY }}
