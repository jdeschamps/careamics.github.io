# This workflow will deploy a new version of the docs to the `latest` version
# of the docs in the gh-pages branch. The repository settings must set the 
# gh-pages branch as the source for the GitHub Pages site, sot hat it automatically
# update them.
name: Deploy to latest

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # needed for git committers

      - name: 💁 Git committer set-up
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
      - name: 🐍 Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 📝 Set up Python environment
        run: |
          pip install -U pip
          pip install -r requirements.txt 

      - name: 🔗 Check Links
        run: |
          npm install markdown-link-check@"<3.11.1"
          npx markdown-link-check docs/**/*.md --progress -q

      - name: 📁 Set up repositories
        run: sh scripts/check_out_repos.sh
      
      - name: 📓 Set up notebooks
        run: sh scripts/check_out_notebooks.sh

      # store `latest` version number into a variable
      - name: 🔬 Get latest version number
        id: extract-version
        run: |
          version=$(mike list | grep '\[latest\]' | awk '{print $1}')
          echo "Latest version is $version"
          echo "latest_version=$version" >> "$GITHUB_ENV"

      # deploy to `latest` using mike
      - name: 📚 Build Docs
        run: |
          pip install -U pip
          pip install -r requirements.txt
          mike deploy --push --update-aliases "$latest_version" latest
